1、执行顺序 创建命名空间 python -m venv myvenv
2、进入命名空间 source myvenv/bin/activate
3、pip install -r ./requirement.txt
4、python manage.py makemigrations
5、python manage.py migrate
6、python manage.py runserver


pip freeze > requirements.txt  生成依赖文件



接口信息
1、数据新建（post）
http://127.0.0.1:8000/vehicles/add/
参数
{
    "vehicle_name": "Car1",
    "year": 2023,
    "price": 3.0,
    "type_name": "SUV1",
    "description": "豪华SUV1",
    "accessories": [
        {"name": "豪华座椅1", "price": 3},
        {"name": "全景天窗1", "price": 3}
    ]
}


2、分页查询（get）
http://127.0.0.1:8000/vehicles/?page=1&page_size=10&vehicle_name=Car1&year=2022

3、更新指定数据
http://127.0.0.1:8000/vehicles/update-prices/
参数
{
  "vehicle_name": "CarB",
  "target_price": 130000,
  "increase_amount": 5000,
  "block_year": 2019
}

4、删除数据
http://127.0.0.1:8000/vehicles/delete-old/
参数
{
  "year": 2019
}





from django.http import JsonResponse
from rest_framework import generics, filters
from django.views.decorators.csrf import csrf_exempt
from .serializers import VehicleInfoSerializer
from .pagination import VehiclePagination
from django.db import transaction
from django.db.models import F
import json
from car.models import vehicle_info, vehicle_type_tab, vehicle_accessory_tab
# Create your views here.
@csrf_exempt
def add_vehicle(request):
    if request.method == 'POST':
        data = json.loads(request.body)
        vehicle = vehicle_info.objects.create(
            vehicle_name=data['vehicle_name'],
            year=data['year'],
            price=data['price'],
            description=data['description']
        )
        vehicle_type_tab.objects.create(
            vehicle_id=vehicle.id,
            type_name=data['type_name']
        )
        for accessory in data['accessories']:
            vehicle_accessory_tab.objects.create(
                vehicle_id=vehicle.id,
                accessory_name=accessory['name'],
                price=accessory['price']
            )
        return JsonResponse({'status': 'success'})
    return JsonResponse({'status': 'error', 'message': 'Invalid request method'}, status=400)



class VehicleListView(generics.ListAPIView):
    queryset = vehicle_info.objects.all()
    serializer_class = VehicleInfoSerializer
    pagination_class = VehiclePagination  # 直接引用分页类
    filter_backends = [filters.SearchFilter]
    search_fields = ['vehicle_name', 'year']

    def get_queryset(self):
        queryset = super().get_queryset()
        vehicle_name = self.request.query_params.get('vehicle_name', '')
        year = self.request.query_params.get('year', '')
        if vehicle_name:
            queryset = queryset.filter(vehicle_name__icontains=vehicle_name)
        if year:
            queryset = queryset.filter(year__icontains=year)
        return queryset.prefetch_related('accessories')

@csrf_exempt
def update_vehicle_prices(request):
    if request.method == 'POST':
        try:
            with transaction.atomic():
                # 保存初始价格和配件总价
                initial_prices = list(vehicle_info.objects.all().values('id', 'price'))
                initial_accessory_prices = list(vehicle_accessory_tab.objects.all().values('id', 'price'))

                # 将 CarB 的价格调整至 130000.0
                vehicle_info.objects.filter(vehicle_name='CarB').update(price=130000.0)

                # 其他车辆的价格增加 5000.0
                vehicle_info.objects.exclude(vehicle_name='CarB').update(price=F('price') + 5000.0)

                # 判断所有车辆，生产年份早于 2019 年并且价格超过（包含）130000.0 的
                vehicles_to_check = vehicle_info.objects.filter(year__lt=2019, price__gte=130000.0)
                if vehicles_to_check.exists():
                    raise ValueError("车辆生产年份早于2019年且价格超过130000.0，无法完成操作。")

                return JsonResponse({'status': 'success'})

        except Exception as e:
            # 回滚所有更改
            transaction.set_rollback(True)
            return JsonResponse({'status': 'error', 'message': str(e)}, status=400)

    return JsonResponse({'status': 'error', 'message': 'Invalid request method'}, status=400)



@csrf_exempt
@csrf_exempt
def delete_vehicles(request):
    if request.method == 'POST':
        try:
            with transaction.atomic():
                # 查询生产年份早于 2019 年的车辆
                vehicles_to_delete = vehicle_info.objects.filter(year__lt=2019)

                # 获取要删除的 vehicle_id 列表
                vehicle_ids = list(vehicles_to_delete.values_list('id', flat=True))

                # 删除对应的车辆类型记录（注意这里要用 vehicle_id）
                vehicle_type_tab.objects.filter(vehicle_id__in=vehicle_ids).delete()

                # 删除对应的车辆配件记录
                vehicle_accessory_tab.objects.filter(vehicle_id__in=vehicle_ids).delete()

                # 删除车辆记录
                vehicles_to_delete.delete()

                return JsonResponse({'status': 'success'})

        except Exception as e:
            return JsonResponse({'status': 'error', 'message': str(e)}, status=400)

    return JsonResponse({'status': 'error', 'message': 'Invalid request method'}, status=400)